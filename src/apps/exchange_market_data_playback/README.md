# Exchange Market Data Playback

Protocol-agnostic market data playback tool with flexible rule-based control over timing, burst patterns, and delivery characteristics.

## Overview

This tool replays binary market data files generated by `exchange_market_data_generator` with configurable playback behavior. It uses a **rules engine architecture** that allows composing multiple independent rules to control message flow.

## Architecture

### Core Components

- **MessageBuffer**: Loads entire file into memory for consistent, fast playback
- **RulesEngine**: Orchestrates multiple playback rules in priority order
- **PlaybackRules**: Individual rules that control timing, flow, and delivery
- **MessageSender**: Abstract interface for output (console, UDP multicast, file, null)
- **PlaybackState**: Tracks statistics and timing during replay

### Rule Priority System

Rules are evaluated in priority order:

```
Priority 0 (SAFETY)   → Rate limits, system protection (never overridden)
Priority 1 (CONTROL)  → Burst patterns, flow control
Priority 2 (TIMING)   → Speed factor, delays
Priority 3 (CHAOS)    → Packet loss, jitter
```

Higher priority rules can override lower priority rules.

## Available Rules

### Control Rules (Priority 1)

**BurstRule** - Send messages in bursts with pauses between
```json
{"mode": "burst", "burst_size": 5000, "burst_interval_ms": 100}
```

**ContinuousRule** - Steady rate playback
```json
{"mode": "continuous", "rate_msgs_per_sec": 10000}
```

**WaveRule** - Oscillating message rate
```json
{"mode": "wave", "period_ms": 10000, "min_rate": 1000, "max_rate": 50000}
```

### Timing Rules (Priority 2)

**SpeedFactorRule** - Multiply/divide playback speed
```json
{"speed_factor": 2.0}  // 2x faster (or 0.5 for half speed)
```

### Safety Rules (Priority 0)

**RateLimitRule** - Enforce maximum rate ceiling
```json
{"max_rate_limit": 100000}  // Never exceed 100K msgs/sec
```

### Chaos Rules (Priority 3)

**PacketLossRule** - Randomly drop messages
```json
{"packet_loss_rate": 0.01}  // Drop 1% of messages
```

**JitterRule** - Add random timing variance
```json
{"max_jitter_us": 1000}  // Up to 1ms random jitter
```

## Usage

### Basic Usage

```bash
# Console output (debug mode) - Default
./exchange_market_data_playback output.itch

# Burst mode with config
./exchange_market_data_playback --config config_burst.json output.mdp

# UDP multicast output
./exchange_market_data_playback --config config_udp.json output.pillar

# File output (save replay)
./exchange_market_data_playback --config config_file.json output.itch

# Null output (dry-run for performance testing)
./exchange_market_data_playback --config config_null.json output.mdp
```

### Output Modes

The playback tool supports multiple output destinations:

#### Console Output (Default)
Prints message numbers to stdout for debugging:
```json
{
  "output": "console",
  "mode": "continuous",
  "rate_msgs_per_sec": 1000
}
```

#### UDP Multicast Output
Sends binary messages via UDP multicast (production mode):
```json
{
  "output": "udp_multicast",
  "multicast_address": "239.255.0.1",
  "multicast_port": 12345,
  "multicast_ttl": 1,
  "mode": "burst",
  "burst_size": 5000,
  "burst_interval_ms": 100
}
```

**Configuration Fields:**
- `multicast_address`: Multicast group address (239.0.0.0 - 239.255.255.255)
- `multicast_port`: UDP port number
- `multicast_ttl`: Time-to-live (1=local network, higher for wider distribution)

**Socket Buffer Tuning:**
The UDP sender automatically configures 2 MB send buffers for high-frequency data. For very high rates (>50K msg/s), you may need to tune OS-level settings:

```bash
# macOS - increase UDP buffer limits
sudo sysctl -w kern.ipc.maxsockbuf=8388608
sudo sysctl -w net.inet.udp.recvspace=2097152

# Linux - increase UDP buffer limits
sudo sysctl -w net.core.rmem_max=8388608
sudo sysctl -w net.core.wmem_max=8388608
```

#### File Output
Writes messages to a binary file:
```json
{
  "output": "file",
  "output_file": "replay_output.bin",
  "mode": "continuous",
  "rate_msgs_per_sec": 10000
}
```

#### Null Output (Dry-Run)
Discards messages (useful for testing rules engine performance):
```json
{
  "output": "null",
  "mode": "burst",
  "burst_size": 100000,
  "burst_interval_ms": 10
}
```

### Testing UDP Multicast Output

The repository includes a Python test listener (`udp_listener.py`) to verify UDP output:

#### Start the Listener

```bash
# Terminal 1 - Start listener with default settings (239.255.0.1:12345)
python3 udp_listener.py

# Or specify custom multicast address and port
python3 udp_listener.py 239.255.1.100 54321
```

**Expected Output:**
```
Listening on 239.255.0.1:12345
Waiting for packets... (Press Ctrl+C to stop)

Received 1000 messages (32000 bytes)
Received 2000 messages (64000 bytes)
Received 3000 messages (96000 bytes)
...
```

#### Run the Playback

```bash
# Terminal 2 - Send data via UDP multicast
./exchange_market_data_playback --config config_udp_slow.json output.mdp
```

The listener will display message counts as packets arrive. Press Ctrl+C to stop and see total statistics.

#### UDP Multicast Localhost Limitations

**Important**: Testing multicast on localhost (same machine) can be problematic on macOS/BSD systems due to multicast loopback routing. You may see:

- Sender reports success (all messages sent, no errors)
- Listener receives 0 messages

This is an **OS limitation**, not a bug in the code. The UDP implementation works correctly on real networks:

✅ **Production**: Works perfectly across network interfaces  
⚠️ **Localhost**: May require special routing configuration  

To test on localhost, you can:
1. Use the `loopback` interface explicitly
2. Test across two separate machines
3. Use Docker containers with host networking
4. Verify with `file` output mode instead

For actual exchange connectivity, UDP multicast will work as expected when connecting to real market data feeds across a network.

### Example Configurations

All example configurations are provided in the repository:

- `config_burst.json` - Burst mode (5000 msgs every 100ms)
- `config_continuous.json` - Steady 10K msgs/sec
- `config_wave.json` - Oscillating rate (1K-50K msgs/sec)
- `config_chaos.json` - Fast + packet loss + jitter
- `config_priority.json` - Priority-aware burst detection
- `config_udp.json` - UDP multicast output
- `config_udp_slow.json` - UDP multicast at 10K msgs/sec (recommended for testing)
- `config_null.json` - Dry-run performance testing

#### Burst Playback (Console Output)
```json
{
  "mode": "burst",
  "burst_size": 5000,
  "burst_interval_ms": 100,
  "speed_factor": 1.0
}
```

#### Continuous with Speed Control
```json
{
  "mode": "continuous",
  "rate_msgs_per_sec": 10000,
  "speed_factor": 2.0,
  "max_rate_limit": 50000
}
```

#### Wave Pattern
```json
{
  "mode": "wave",
  "period_ms": 10000,
  "min_rate": 1000,
  "max_rate": 50000
}
```

#### Chaos Testing
```json
{
  "output": "console",
  "mode": "burst",
  "burst_size": 10000,
  "burst_interval_ms": 50,
  "speed_factor": 10.0,
  "packet_loss_rate": 0.01,
  "max_jitter_us": 1000
}
```

#### UDP Multicast Output
```json
{
  "output": "udp_multicast",
  "multicast_address": "239.255.0.1",
  "multicast_port": 12345,
  "multicast_ttl": 1,
  "mode": "continuous",
  "rate_msgs_per_sec": 10000,
  "max_rate_limit": 50000
}
```

## Python UDP Listener

The `udp_listener.py` script is provided for testing UDP multicast output:

### Features
- Joins multicast group and receives packets
- 2 MB receive buffer for high-frequency data
- Displays progress every 1000 messages
- Shows total statistics on exit

### Usage
```bash
# Default (239.255.0.1:12345)
python3 udp_listener.py

# Custom address/port
python3 udp_listener.py 239.255.1.100 54321

# Run in background
python3 udp_listener.py &
```

### Output Example
```
Listening on 239.255.0.1:12345
Waiting for packets... (Press Ctrl+C to stop)

Received 1000 messages (32000 bytes)
Received 2000 messages (64000 bytes)
Received 3000 messages (96000 bytes)

^C

Total messages received: 3247
Total bytes received: 103904
```

### Testing Workflow
```bash
# Terminal 1: Start listener
python3 udp_listener.py

# Terminal 2: Send market data via UDP
./exchange_market_data_playback --config config_udp_slow.json output.mdp

# Terminal 1 will show received messages
# Press Ctrl+C in Terminal 1 to see final statistics
```

## Rule Interactions

Rules compose together. Examples:

### Burst + Speed Factor
```json
{
  "mode": "burst",
  "burst_size": 5000,
  "burst_interval_ms": 100,
  "speed_factor": 2.0
}
```
**Result**: Sends 5000 messages, waits 50ms (100ms / 2.0), repeat

### Continuous + Rate Limit
```json
{
  "mode": "continuous",
  "rate_msgs_per_sec": 100000,
  "max_rate_limit": 50000
}
```
**Result**: Tries to send at 100K msgs/sec, but safety rule caps at 50K

### Burst + Packet Loss + Speed
```json
{
  "mode": "burst",
  "burst_size": 10000,
  "burst_interval_ms": 100,
  "speed_factor": 5.0,
  "packet_loss_rate": 0.05
}
```
**Result**: Fast bursts (5x speed) with 5% random packet loss

## Testing Scenarios

### Debug Mode (Slow, Detailed)
```json
{
  "mode": "continuous",
  "rate_msgs_per_sec": 100,
  "speed_factor": 0.1
}
```

### Production Validation (Real-time)
```json
{
  "mode": "burst",
  "burst_size": 5000,
  "burst_interval_ms": 100,
  "speed_factor": 1.0
}
```

### Stress Test (Fast)
```json
{
  "mode": "burst",
  "burst_size": 50000,
  "burst_interval_ms": 10,
  "speed_factor": 10.0,
  "max_rate_limit": 1000000
}
```

### Chaos Test (Unpredictable)
```json
{
  "mode": "continuous",
  "rate_msgs_per_sec": 50000,
  "packet_loss_rate": 0.10,
  "max_jitter_us": 5000
}
```

### Soak Test (Time Compression)
```json
{
  "mode": "continuous",
  "rate_msgs_per_sec": 10000,
  "speed_factor": 100.0
}
```
**Compresses hours into minutes**

## Output

```
═══════════════════════════════════════════════════════════════════════════════
                     MARKET DATA PLAYBACK - STARTING                           
═══════════════════════════════════════════════════════════════════════════════
  File:     output.mdp
  Messages: 10000
  Rules:    3 configured
═══════════════════════════════════════════════════════════════════════════════

Configured: Burst mode (5000 msgs every 100ms)
Configured: Speed factor 2.0x
Configured: Rate limit 100000 msgs/sec (SAFETY)

Progress: 10000/10000 (100.0%) | Rate: 52341 msg/s | Sent: 9950 | Dropped: 0

═══════════════════════════════════════════════════════════════════════════════
                      MARKET DATA PLAYBACK - COMPLETE                          
═══════════════════════════════════════════════════════════════════════════════
  Duration:      185 ms
  Total Sent:    9950
  Dropped:       50
  Queued:        0
  Average Rate:  53784 msg/s
═══════════════════════════════════════════════════════════════════════════════
```

## Building

```bash
cd exchange_market_data_playback
./build.sh
```

Binary output: `build/exchange_market_data_playback`

## Troubleshooting

### UDP Multicast Issues

**Problem**: Sender succeeds but listener receives 0 messages on localhost

**Cause**: macOS/BSD multicast loopback routing limitation

**Solutions**:
1. **Test on real network**: Deploy sender and receiver on different machines
2. **Use file output**: Verify functionality with `"output": "file"` mode
3. **Check network interface**: Ensure multicast is enabled on active interface
4. **Docker**: Use containers with host networking mode

**Verification**:
```bash
# Check if multicast is enabled on interface
netstat -g

# Test with file output instead
./exchange_market_data_playback --config config_file.json output.mdp
ls -lh replay_output.bin  # Should show file with data
```

### "No buffer space available" Errors

**Problem**: UDP sender reports buffer errors

**Cause**: OS UDP buffer too small for high message rates

**Solution**: Increase system UDP buffer limits
```bash
# macOS
sudo sysctl -w kern.ipc.maxsockbuf=8388608
sudo sysctl -w net.inet.udp.recvspace=2097152

# Linux  
sudo sysctl -w net.core.rmem_max=8388608
sudo sysctl -w net.core.wmem_max=8388608
```

Or reduce playback rate in configuration:
```json
{
  "rate_msgs_per_sec": 5000,
  "max_rate_limit": 10000
}
```

### High Packet Loss

**Problem**: Many messages dropped during playback

**Expected**: Some loss is normal with `PacketLossRule` enabled

**Check Configuration**:
```json
{
  "packet_loss_rate": 0.05  // 5% intentional loss for chaos testing
}
```

If unintentional, remove `packet_loss_rate` from config.

### Performance Issues

**Problem**: Playback slower than configured rate

**Causes**:
1. Console output overhead (use UDP or null output for high rates)
2. System load (close other applications)
3. Rate limit rule too restrictive

**Solutions**:
```bash
# Use null output for maximum performance
./exchange_market_data_playback --config config_null.json output.mdp

# Or increase rate limit
{
  "max_rate_limit": 1000000  // 1M msgs/sec
}
```

## Files Included

### Binaries
- `exchange_market_data_playback` - Main executable

### Configuration Files
- `config_burst.json` - Burst pattern example
- `config_continuous.json` - Steady rate example
- `config_wave.json` - Oscillating rate example
- `config_chaos.json` - Chaos testing with packet loss
- `config_priority.json` - Priority-aware example
- `config_udp.json` - UDP multicast output
- `config_udp_slow.json` - UDP at moderate rate (testing)
- `config_null.json` - Dry-run mode

### Test Tools
- `udp_listener.py` - Python UDP multicast receiver for testing

### Documentation
- `README.md` - This file
- `ARCHITECTURE.md` - System design and flow diagrams
- `PRIORITY_SYSTEM.md` - Priority-aware message handling

## Implementation Notes

### Socket Configuration

The UDP multicast sender uses optimized socket settings:
- **Send buffer**: 2 MB (configurable via setsockopt)
- **TTL**: Configurable (default 1 for local network)
- **Non-blocking**: No, uses blocking I/O with timing control
- **Error handling**: Reports errors but continues playback

### Performance Characteristics

Tested on Apple M1 (AppleClang 17.0.0):
- **Console output**: ~60K msgs/sec sustained
- **Null output**: ~500K+ msgs/sec sustained  
- **File output**: ~200K msgs/sec sustained
- **UDP output**: ~50K msgs/sec sustained (network limited)

Memory usage: ~640 KB per 20K messages loaded

### Protocol Compatibility

Works with all 32-byte market data formats:
- NASDAQ ITCH v5.0
- NYSE Pillar v1.9
- CME MDP MBO v4.0

The playback tool is protocol-agnostic - it treats all messages as 32-byte binary chunks.

## Future Enhancements

- TCP unicast sender
- Multiple simultaneous outputs (UDP + file)
- Live rate adjustment via signals
- Composite classifiers (symbol + time + burst detection)
- Statistics export (CSV, JSON)
- Replay from timestamp range
- Message filtering by symbol (requires protocol awareness)

---

**Project**: Beacon  
**Application**: exchange_market_data_playback  
**Author**: Bryan Camp
